
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Intel TDX机密容器 · CNCC-sig</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="CNCC-sig.cn">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-alerts/style.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-tbfed-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-sectionx/sectionx.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-chapter-fold/chapter-fold.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-emphasize/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-tags/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-hints/plugin-hints.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="vsgx.html" />
    
    
    <link rel="prev" href="vcsv.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    机密计算简介与现状
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../confidential_computing.html">
            
                <a href="../confidential_computing.html">
            
                    
                    云原生机密计算SIG概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    机密计算平台
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../cc_platform/hygon_csv.html">
            
                <a href="../cc_platform/hygon_csv.html">
            
                    
                    海光CSV：海光安全虚拟化技术
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../cc_platform/sgx_and_dcap.html">
            
                <a href="../cc_platform/sgx_and_dcap.html">
            
                    
                    Intel SGX: Intel安全防护扩展
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../cc_platform/tdx.html">
            
                <a href="../cc_platform/tdx.html">
            
                    
                    Intel TDX: Intel安全虚拟化技术
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../cc_platform/amd_sev.html">
            
                <a href="../cc_platform/amd_sev.html">
            
                    
                    AMD SEV: AMD安全加密虚拟化技术
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../cc_platform/arm_cca.html">
            
                <a href="../cc_platform/arm_cca.html">
            
                    
                    ARM CCA: Arm安全加密虚拟化技术
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    编程框架
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../framework/sgx_cc.html">
            
                <a href="../framework/sgx_cc.html">
            
                    
                    Intel SGX SDK/PSW/DCAP: Intel SGX软件开发套件和平台软件服务
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../framework/intel_HE.html">
            
                <a href="../framework/intel_HE.html">
            
                    
                    Intel Homomorphic Encryption: Intel平台同态加密加速框架
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.2.1" data-path="../framework/he_development_guide.html">
            
                <a href="../framework/he_development_guide.html">
            
                    
                    Intel_HE_Toolkit开发指南
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../framework/java_enclave.html">
            
                <a href="../framework/java_enclave.html">
            
                    
                    Apache Teaclave Java TEE SDK: 面向Java生态的机密计算编程框架
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.3.1" data-path="../framework/java_enclave_development_guide.html">
            
                <a href="../framework/java_enclave_development_guide.html">
            
                    
                    Apache_Teaclave_Java_TEE_SDK最佳实践
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../framework/rats_tls.html">
            
                <a href="../framework/rats_tls.html">
            
                    
                    RATS-TLS: 跨机密计算平台的双向传输层安全协议
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" >
            
                <span>
            
                    
                    运行时底座
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="csv_cc.html">
            
                <a href="csv_cc.html">
            
                    
                    海光CSV机密容器
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1.1" data-path="csv_runtime_attestation.html">
            
                <a href="csv_runtime_attestation.html">
            
                    
                    基于runtime-attestation使用机密容器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.2" data-path="csv_pre_attestation.html">
            
                <a href="csv_pre_attestation.html">
            
                    
                    基于pre-attestation使用机密容器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.1.3" data-path="csv_sign.html">
            
                <a href="csv_sign.html">
            
                    
                    基于runtime-attestation使用签名容器
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="vcsv.html">
            
                <a href="vcsv.html">
            
                    
                    海光CSV机密虚拟机
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.5.3" data-path="tdx.html">
            
                <a href="tdx.html">
            
                    
                    Intel TDX机密容器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="vsgx.html">
            
                <a href="vsgx.html">
            
                    
                    Intel vSGX：Intel SGX虚拟化
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.4.1" data-path="run_vsgx.html">
            
                <a href="run_vsgx.html">
            
                    
                    Intel SGX虚拟机最佳实践
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="sev_cc.html">
            
                <a href="sev_cc.html">
            
                    
                    AMD SEV机密容器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="vsev.html">
            
                <a href="vsev.html">
            
                    
                    AMD SEV机密虚拟机
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.7" data-path="occlum.html">
            
                <a href="occlum.html">
            
                    
                    Occlum: 基于Intel SGX的轻量级LibOS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.8" data-path="inclavare_containers.html">
            
                <a href="inclavare_containers.html">
            
                    
                    Inclavare Containers: 面向机密计算场景的开源容器运行时技术栈
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.9" data-path="enclave_cc.html">
            
                <a href="enclave_cc.html">
            
                    
                    Enclave-CC: 进程级机密容器
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <span>
            
                    
                    解决方案
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../solution/cczoo.html">
            
                <a href="../solution/cczoo.html">
            
                    
                    Intel Confidential Computing Zoo: Intel机密计算开源解决方案
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1.1" data-path="../solution/online_reasoning_service.html">
            
                <a href="../solution/online_reasoning_service.html">
            
                    
                    部署TensorFlow Serving在线推理服务
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.2" data-path="../solution/horizontal_federated_learning.html">
            
                <a href="../solution/horizontal_federated_learning.html">
            
                    
                    部署TensorFlow横向联邦学习
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.1.3" data-path="../solution/privacy_set_intersection.html">
            
                <a href="../solution/privacy_set_intersection.html">
            
                    
                    部署隐私集合求交方案
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../solution/ppml.html">
            
                <a href="../solution/ppml.html">
            
                    
                    PPML: 端到端隐私保护机器学习解决方案
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Intel TDX机密容器</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="intel-tdx&#x673A;&#x5BC6;&#x5BB9;&#x5668;">Intel TDX&#x673A;&#x5BC6;&#x5BB9;&#x5668;</h1>
<p>&#x672C;&#x6587;&#x4E3B;&#x8981;&#x4E3A;&#x60A8;&#x4ECB;&#x7ECD;&#x5982;&#x4F55;&#x57FA;&#x4E8E;Intel&#x4FE1;&#x4EFB;&#x57DF;(TD)&#x7684;&#x786C;&#x4EF6;&#x9694;&#x79BB;&#x865A;&#x62DF;&#x5316;&#x529F;&#x80FD;TDX(Intel Trust Domain Extensions) &#xFF08; <a href="https://www.intel.com/content/www/us/en/developer/articles/technical/intel-trust-domain-extensions.html" target="_blank">https://www.intel.com/content/www/us/en/developer/articles/technical/intel-trust-domain-extensions.html</a> &#xFF09;&#x6280;&#x672F;&#xFF0C;&#x901A;&#x8FC7;&#x8FDC;&#x7A0B;&#x8BC1;&#x660E;&#x542F;&#x52A8;&#x4E00;&#x4E2A;&#x79DF;&#x6237;&#x7684;&#x52A0;&#x5BC6;&#x7B7E;&#x540D;&#x5BB9;&#x5668;&#x955C;&#x50CF;&#x3002;</p>
<h2 id="&#x524D;&#x63D0;&#x6761;&#x4EF6;">&#x524D;&#x63D0;&#x6761;&#x4EF6;</h2>
<h3 id="1&#x3001;&#x5B89;&#x88C5;anolis-86-&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;">1&#x3001;&#x5B89;&#x88C5;Anolis 8.6 &#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;</h3>
<p>&#x8BF7;&#x5728;&#x652F;&#x6301;INTEL TDX CPU&#x7684;&#x786C;&#x4EF6;&#x8BBE;&#x5907;&#x4E0A;&#xFF0C;&#x53C2;&#x8003;<a href="https://mirrors.openanolis.cn/anolis/8.6/isos/GA/" target="_blank">Anolis 8.6 GA&#x8BF4;&#x660E;&#x6587;&#x6863;</a>&#x5B89;&#x88C5;anolis 8.6 GA&#x3002;</p>
<h3 id="2&#x3001;&#x5347;&#x7EA7;&#x5185;&#x6838;&#x5230;510">2&#x3001;&#x5347;&#x7EA7;&#x5185;&#x6838;&#x5230;5.10</h3>
<p>&#x7531;&#x4E8E; Anlois 8.6 &#x7684;&#x9ED8;&#x8BA4;&#x5185;&#x6838;&#x7248;&#x672C;&#x662F;4.19&#xFF0C;&#x8BF7;&#x5347;&#x7EA7;kernel &#x5230;5.10&#x7248;&#x672C;&#x3002;</p>
<ul>
<li>&#x6DFB;&#x52A0; yum &#x6E90;&#x914D;&#x7F6E;&#x53C2;&#x6570;&#xFF0C;&#x6DFB;&#x52A0;Anolis &#x7684; Experimental repo&#x3002;</li>
</ul>
<pre><code class="lang-sh">yum install yum-utils
yum-config-manager --add-repo https://mirrors.openanolis.cn/anolis/8/kernel-5.10/x86_64/os/
</code></pre>
<ul>
<li>&#x5347;&#x7EA7;&#x5185;&#x6838;</li>
</ul>
<pre><code class="lang-sh">yum update kernel
</code></pre>
<ul>
<li>&#x91CD;&#x542F;&#x673A;&#x5668;&#xFF0C;&#x5E76;&#x91CD;&#x65B0;&#x67E5;&#x770B;&#x673A;&#x5668;&#x7684;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x53D1;&#x884C;&#x7F16;&#x53F7;&#x3002;</li>
</ul>
<pre><code class="lang-sh">reboot
uname -r
</code></pre>
<ul>
<li>&#x9884;&#x671F;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#xFF1A;</li>
</ul>
<pre><code class="lang-sh">5.10.134-13_rc2.an8.x86_64
</code></pre>
<h3 id="3&#x3001;&#x4F7F;&#x80FD;tdx">3&#x3001;&#x4F7F;&#x80FD;TDX</h3>
<ul>
<li><p>&#x91CD;&#x542F;&#x540E;&#xFF0C;&#x8BF7;&#x68C0;&#x67E5;&#x673A;&#x5668;&#x7684;tdx&#x4F7F;&#x80FD;&#x72B6;&#x6001;&#x3002;</p>
</li>
<li><p>&#x9884;&#x671F;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#xFF1A;</p>
</li>
</ul>
<pre><code class="lang-sh">[    1.481148] seam: Loading TDX P-SEAMLDR intel-seam/np-seamldr.acm.
[    1.482177] seam: Successfully loaded TDX P-SEAMLDR.
[    1.482195] tdx: Build all system memory blocks as TDX memory.
[    5.919528] tdx: Loaded TDX module via P-SEAMLDR.
[    5.919763] tdx: TDX SEAM module: attributes 0x0 vendor_id 0x8086 build_date 20220420 build_num 0x156 minor_version 0x0 major_version 0x1.
[    6.379342] tdx: Successfully initialized TDX module
</code></pre>
<h2 id="&#x80CC;&#x666F;&#x4FE1;&#x606F;">&#x80CC;&#x666F;&#x4FE1;&#x606F;</h2>
<p><img src="../materials/imgs/tdx_overview.png" alt=""></p>
<p>&#x82F1;&#x7279;&#x5C14; TDX Pod &#x7EA7;&#x673A;&#x5BC6;&#x5BB9;&#x5668;&#x662F;&#x5C06;TDX&#x786C;&#x4EF6;&#x5B89;&#x5168;&#x865A;&#x62DF;&#x5316;&#x6280;&#x672F;&#x540C;&#x5BB9;&#x5668;&#x751F;&#x6001;&#x65E0;&#x7F1D;&#x96C6;&#x6210;&#xFF0C;&#x4EE5;&#x4E91;&#x539F;&#x751F;&#x65B9;&#x5F0F;&#x8FD0;&#x884C;&#xFF0C;&#x4FDD;&#x62A4;&#x654F;&#x611F;&#x5DE5;&#x4F5C;&#x8D1F;&#x8F7D;&#x548C;&#x6570;&#x636E;&#x7684;&#x673A;&#x5BC6;&#x6027;&#x548C;&#x5B8C;&#x6574;&#x6027;&#x3002;&#x662F;&#x76EE;&#x524D;&#x673A;&#x5BC6;&#x5BB9;&#x5668;&#x793E;&#x533A;&#xFF08; <a href="https://github.com/confidential-containers" target="_blank">https://github.com/confidential-containers</a> &#xFF09;&#x4E3B;&#x8981;&#x652F;&#x6301;&#x7684;&#x5E95;&#x5C42;&#x786C;&#x4EF6;&#x4E4B;&#x4E00;&#x3002;&#x76F8;&#x5BF9;&#x4E8E;&#x4F20;&#x7EDF;&#x57FA;&#x4E8E;&#x865A;&#x62DF;&#x673A;&#x7684;&#x5BB9;&#x5668;&#x6280;&#x672F;&#xFF0C;&#x673A;&#x5BC6;&#x5BB9;&#x5668;&#x505A;&#x4E86;&#x5F88;&#x591A;&#x5B89;&#x5168;&#x7684;&#x589E;&#x5F3A;&#xFF0C;&#x6BD4;&#x5982;trusted boot, restricted API, encrypted/signed image, remote attestation&#xFF0C;&#x8FD9;&#x4E9B;&#x6280;&#x672F;&#x90FD;&#x96C6;&#x6210;&#x4E3A;&#x673A;&#x5BC6;&#x5BB9;&#x5668;runtime stack&#x7684;&#x4E00;&#x90E8;&#x5206;&#x3002;&#x5728;TEE&#x4FDD;&#x62A4;&#x7684;guest &#x5185;&#x90E8;&#xFF0C;&#x9ED8;&#x8BA4;&#x96C6;&#x6210;&#x4E86; image-rs &#x548C; attestation-agent &#x7B49;&#x7EC4;&#x4EF6;&#xFF0C;&#x5B83;&#x4EEC;&#x8D1F;&#x8D23;&#x5B9E;&#x73B0;&#x5BB9;&#x5668;&#x955C;&#x50CF;&#x7684;&#x62C9;&#x53D6;&#x3001;&#x6388;&#x6743;&#x3001;&#x9A8C;&#x7B7E;&#x3001;&#x89E3;&#x5BC6;&#x3001;&#x8FDC;&#x7A0B;&#x8BC1;&#x660E;&#x4EE5;&#x53CA;&#x79D8;&#x5BC6;&#x6CE8;&#x5165;&#x7B49;&#x5B89;&#x5168;&#x7279;&#x6027;&#x3002;&#x673A;&#x5BC6;&#x5BB9;&#x5668;&#x7684;&#x57FA;&#x672C;&#x8FD0;&#x884C;&#x8FC7;&#x7A0B;&#x4E3A;&#xFF1A;</p>
<ul>
<li><p>&#x7528;&#x6237;&#x4F7F;&#x7528;&#x6807;&#x51C6;&#x5DE5;&#x5177;&#x5236;&#x4F5C;&#x4E00;&#x4E2A;&#x7B7E;&#x540D;&#x548C;/&#x6216;&#x52A0;&#x5BC6;&#x7684;&#x53D7;&#x4FDD;&#x62A4;&#x7684;&#x5BB9;&#x5668;&#x955C;&#x50CF;&#xFF0C;&#x5E76;&#x4E0A;&#x4F20;&#x5230;&#x5BB9;&#x5668;&#x955C;&#x50CF;&#x4ED3;&#x5E93;&#x4E2D;&#x3002;</p>
</li>
<li><p>&#x7528;&#x6237;&#x547D;&#x4EE4; Kubernetes &#x542F;&#x52A8;&#x8FD9;&#x4E2A;&#x53D7;&#x4FDD;&#x62A4;&#x7684;&#x5BB9;&#x5668;&#x955C;&#x50CF;&#x3002;kubelet &#x4F1A;&#x5411; containerd &#x53D1;&#x8D77;&#x521B;&#x5EFA; Pod &#x7684; CRI &#x8BF7;&#x6C42;&#xFF0C;containerd &#x5219;&#x628A;&#x8BF7;&#x6C42;&#x8F6C;&#x53D1;&#x7ED9; kata-runtime&#xFF0C;kata-runtime &#x542F;&#x52A8;&#x4E00;&#x4E2A;TDX &#x4FDD;&#x62A4;&#x7684;&#x8F7B;&#x91CF;&#x7EA7;VM, &#x76EE;&#x524D;&#x652F;&#x6301;TDX &#x7684;VMM &#x6709;Dragonball&#xFF0C;Cloud Hypervisor, Qemu&#x3002;</p>
</li>
<li><p>kubelet &#x5411; containerd &#x53D1;&#x8D77; Image Pulling &#x7684; CRI &#x8BF7;&#x6C42;&#xFF0C;containerd &#x5219;&#x628A;&#x8BF7;&#x6C42;&#x8F6C;&#x53D1;&#x7ED9; kata-runtime&#xFF0C;&#x6700;&#x7EC8; kata-agent &#x6536;&#x5230;&#x8BF7;&#x6C42;&#x5E76;&#x901A;&#x8FC7; image-rs &#x5B50;&#x6A21;&#x5757;&#x63D0;&#x4F9B;&#x7684;&#x5BB9;&#x5668;&#x955C;&#x50CF;&#x7BA1;&#x7406;&#x529F;&#x80FD;&#xFF0C;&#x5728;&#x4E0B;&#x8F7D;image&#x4E4B;&#x524D;&#xFF0C;image-rs&#x4F1A;&#x8DDF;attestation-agent&#x8FDB;&#x884C;&#x8FDC;&#x7A0B;&#x8BA4;&#x8BC1;&#x3002;</p>
</li>
<li><p>Attestation-agent &#x4E0E; Key broker service&#xFF08;verdictd&#xFF09;&#x5EFA;&#x7ACB;&#x5B89;&#x5168;&#x4F1A;&#x8BDD;&#xFF0C;&#x5E76;&#x8FDB;&#x884C;&#x57FA;&#x4E8E;runtime stack&#x542F;&#x52A8;&#x8FC7;&#x7A0B;&#x4E2D;&#x7684;&#x5EA6;&#x91CF;&#x503C;&#x8FDB;&#x884C;&#x8FDC;&#x7A0B;&#x8BA4;&#x8BC1;&#xFF0C;&#x786E;&#x4FDD;runtime&#x6CA1;&#x6709;&#x88AB;&#x7BE1;&#x6539;&#x3002;&#x53EA;&#x6709;&#x901A;&#x8FC7;&#x8FDC;&#x7A0B;&#x8BA4;&#x8BC1;&#xFF0C;image&#x89E3;&#x5BC6;key&#xFF0C;&#x7B7E;&#x540D;&#x7684;policy&#x548C;&#x8BC1;&#x4E66;&#x624D;&#x4F1A;&#x4F20;&#x9001;&#x5230;TEE&#x4FDD;&#x62A4;&#x7684;guest&#x5185;&#x90E8;&#x3002;</p>
</li>
<li><p>&#x901A;&#x8FC7;&#x8FDC;&#x7A0B;&#x8BC1;&#x660E;&#x540E;&#xFF0C;&#x62FF;&#x5230;image policy&#x6587;&#x4EF6;&#xFF0C;&#x7B7E;&#x540D;&#x8BC1;&#x4E66;&#xFF0C;&#x89E3;&#x5BC6;image key&#xFF0C;image-rs&#x8FDB;&#x884C;&#x9A8C;&#x7B7E;&#x3001;&#x89E3;&#x5BC6;&#x3001;unpack &#x4EE5;&#x53CA;&#x6302;&#x8F7D;&#x5BB9;&#x5668;&#x955C;&#x50CF;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x6700;&#x7EC8;&#x987A;&#x5229;&#x542F;&#x52A8;container&#x3002;</p>
</li>
</ul>
<h2 id="&#x6B65;&#x9AA4;&#x4E00;&#xFF1A;&#x90E8;&#x7F72;&#x6D4B;&#x8BD5;&#x96C6;&#x7FA4;">&#x6B65;&#x9AA4;&#x4E00;&#xFF1A;&#x90E8;&#x7F72;&#x6D4B;&#x8BD5;&#x96C6;&#x7FA4;</h2>
<p>&#x672C;&#x6B65;&#x9AA4;&#x4E3A;&#x60A8;&#x63D0;&#x4F9B;&#x5FEB;&#x901F;&#x90E8;&#x7F72;&#x5355;&#x8282;&#x70B9;&#x6D4B;&#x8BD5;&#x96C6;&#x7FA4;&#x7684;&#x6B65;&#x9AA4;&#x3002;&#x60A8;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x60A8;&#x7684;&#x9700;&#x6C42;&#xFF0C;&#x7075;&#x6D3B;&#x90E8;&#x7F72;&#x96C6;&#x7FA4;&#x3002;</p>
<h3 id="&#x914D;&#x7F6E;&#x6743;&#x9650;">&#x914D;&#x7F6E;&#x6743;&#x9650;</h3>
<h4 id="&#x5173;&#x95ED;firewall">&#x5173;&#x95ED;firewall</h4>
<p>Linux&#x7CFB;&#x7EDF;&#x4E0B;&#x9762;&#x81EA;&#x5E26;&#x4E86;&#x9632;&#x706B;&#x5899; iptables &#xFF0C;iptables &#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#x5F88;&#x591A;&#x5B89;&#x5168;&#x89C4;&#x5219;&#x3002;&#x4F46;&#x662F;&#x5982;&#x679C;&#x914D;&#x7F6E;&#x9519;&#x8BEF;&#x5F88;&#x5BB9;&#x6613;&#x5BFC;&#x81F4;&#x5404;&#x79CD;&#x7F51;&#x7EDC;&#x95EE;&#x9898;&#x3002;&#x6B64;&#x5904;&#x5EFA;&#x8BAE;&#x5173;&#x95ED; firewall &#x3002; &#x6267;&#x884C;&#x5982;&#x4E0B;&#x64CD;&#x4F5C;&#xFF1A;</p>
<pre><code class="lang-sh">sudo service firewalld stop
</code></pre>
<p>&#x68C0;&#x67E5; firewall &#x72B6;&#x6001;&#xFF1A;</p>
<pre><code class="lang-sh">service firewalld status
</code></pre>
<p>&#x9884;&#x671F;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code class="lang-sh">Redirecting to /bin/systemctl status firewalld.service
&#x25CF; firewalld.service - firewalld - dynamic firewall daemon
   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)
   Active: inactive (dead)
     Docs: man:firewalld(1)
</code></pre>
<h4 id="&#x5173;&#x95ED;selinux">&#x5173;&#x95ED;selinux</h4>
<p>Security-Enhanced Linux&#xFF08;SELinux&#xFF09;&#x662F;&#x4E00;&#x4E2A;&#x5728;&#x5185;&#x6838;&#x4E2D;&#x5B9E;&#x65BD;&#x7684;&#x5F3A;&#x5236;&#x5B58;&#x53D6;&#x63A7;&#x5236;&#xFF08;MAC&#xFF09;&#x5B89;&#x5168;&#x6027;&#x673A;&#x5236;&#x3002;&#x4E3A;&#x907F;&#x514D;&#x51FA;&#x73B0;&#x6743;&#x9650;&#x63A7;&#x5236;&#x5BFC;&#x81F4;&#x7684;&#x865A;&#x62DF;&#x673A;&#x542F;&#x52A8;&#x3001;&#x8BBF;&#x95EE;&#x5931;&#x8D25;&#x7B49;&#x95EE;&#x9898;&#xFF0C;&#x6B64;&#x5904;&#x5EFA;&#x8BAE;&#x5173;&#x95ED;selinux&#x3002;&#x6267;&#x884C;&#x5982;&#x4E0B;&#x64CD;&#x4F5C;&#xFF1A;</p>
<pre><code class="lang-sh">setenforce 0
</code></pre>
<p>&#x9884;&#x671F;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code class="lang-sh">setenforce: SELinux is disabled
</code></pre>
<h3 id="&#x914D;&#x7F6E;containerd">&#x914D;&#x7F6E;containerd</h3>
<p>&#x81EA;&#x52A8;&#x751F;&#x6210;&#x9ED8;&#x8BA4;&#x7684;config.toml</p>
<pre><code class="lang-sh">containerd config default &gt; /etc/containerd/config.toml
</code></pre>
<p>&#x7531;&#x4E8E;&#x9ED8;&#x8BA4;&#x7684; config.toml &#x4F7F;&#x7528;&#x7684;&#x662F;&#x56FD;&#x5916;&#x7684;&#x955C;&#x50CF;&#xFF0C;&#x56FD;&#x5185;&#x6709;&#x53EF;&#x80FD;&#x65E0;&#x6CD5;&#x8BBF;&#x95EE;&#x3002;&#x8BF7;&#x53C2;&#x8003;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x4FEE;&#x6539;&#x4E3A;&#x56FD;&#x5185;&#x955C;&#x50CF;&#x3002;</p>
<pre><code class="lang-sh"><span class="hljs-built_in">cd</span> /etc/containerd
sed -i <span class="hljs-string">&apos;s#registry.k8s.io/pause:3.6#registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1#g&apos;</span> config.toml
</code></pre>
<p>&#x542F;&#x52A8; containerd</p>
<pre><code class="lang-sh">systemctl containerd start
</code></pre>
<h3 id="&#x90E8;&#x7F72;&#x5355;&#x8282;&#x70B9;&#x7684;kubernetes-cluster">&#x90E8;&#x7F72;&#x5355;&#x8282;&#x70B9;&#x7684;Kubernetes cluster</h3>
<ul>
<li>&#x8BF7;&#x53C2;&#x8003;<a href="https://github.com/kubernetes/kubernetes" target="_blank">kubernetes</a>&#x5B98;&#x65B9;&#x6307;&#x5357;&#x5B89;&#x88C5;Kubernetes cluster&#x3002;&#x6700;&#x4F4E; Kubernetes &#x7248;&#x672C;&#x5E94;&#x4E3A; 1.24&#x3002;</li>
<li>&#x786E;&#x4FDD;&#x96C6;&#x7FA4;&#x4E2D;&#x81F3;&#x5C11;&#x6709;&#x4E00;&#x4E2A; Kubernetes &#x8282;&#x70B9;&#x5177;&#x6709;&#x6807;&#x7B7E; node-role.kubernetes.io/worker=</li>
</ul>
<pre><code class="lang-sh">kubectl label node &lt;node-name&gt; node-role.kubernetes.io/worker=
</code></pre>
<h2 id="&#x6B65;&#x9AA4;&#x4E8C;&#xFF1A;&#x5B89;&#x88C5;confidential-computing-operator">&#x6B65;&#x9AA4;&#x4E8C;&#xFF1A;&#x5B89;&#x88C5;Confidential computing Operator</h2>
<p>Confidential computing Operator &#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD;&#x5728; Kubernetes &#x96C6;&#x7FA4;&#x4E0A;&#x90E8;&#x7F72;&#x548C;&#x7BA1;&#x7406; Confidential Containers Runtime &#x7684;&#x65B9;&#x6CD5;&#x3002;&#x5177;&#x4F53;&#x4FE1;&#x606F;&#x8BF7;&#x53C2;&#x8003;<a href="https://github.com/confidential-containers/operator" target="_blank">&#x6307;&#x5357;</a>&#x3002;</p>
<h3 id="&#x524D;&#x63D0;&#x6761;&#x4EF6;">&#x524D;&#x63D0;&#x6761;&#x4EF6;</h3>
<p>1&#x3001;&#x786E;&#x4FDD; Kubernetes &#x96C6;&#x7FA4;&#x8282;&#x70B9;&#x81F3;&#x5C11;&#x6709; 8GB RAM &#x548C; 4 &#x4E2A; vCPU</p>
<p>2&#x3001;&#x5F53;&#x524D; CoCo &#x7248;&#x672C;&#x4EC5;&#x652F;&#x6301;&#x57FA;&#x4E8E; containerd &#x8FD0;&#x884C;&#x65F6;&#x7684; Kubernetes &#x96C6;&#x7FA4;</p>
<p>3&#x3001;&#x786E;&#x4FDD; SELinux &#x88AB;&#x7981;&#x7528;&#x6216;&#x672A;&#x5F3A;&#x5236;&#x6267;&#x884C; (confidential-containers/operator#115)</p>
<h3 id="&#x90E8;&#x7F72;operator">&#x90E8;&#x7F72;Operator</h3>
<p>Operator&#x76EE;&#x524D;&#x6709;3&#x4E2A;<a href="https://github.com/confidential-containers/operator/tags" target="_blank">&#x7248;&#x672C;</a>&#xFF0C;&#x8FD9;&#x91CC;&#x9ED8;&#x8BA4;&#x5B89;&#x88C5;&#x6700;&#x65B0;&#x7248;v0.3.0&#x7248;&#x672C;&#x3002; &#x901A;&#x8FC7;&#x8FD0;&#x884C;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x90E8;&#x7F72;Operator&#xFF1A;</p>
<pre><code class="lang-sh">kubectl apply -k github.com/confidential-containers/operator/config/release?ref=v0.3.0
</code></pre>
<p>cc-operator-controller-manager &#x8D44;&#x6E90;&#x4F9D;&#x8D56;&#x56FD;&#x5916;&#x7684;&#x955C;&#x50CF;&#xFF0C;&#x53EF;&#x80FD;&#x62C9;&#x4E0D;&#x4E0B;&#x6765;&#xFF0C;&#x8BF7;&#x53C2;&#x8003;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#x5BF9;&#x955C;&#x50CF;&#x8FDB;&#x884C;&#x4FEE;&#x6539;&#xFF1A;</p>
<pre><code class="lang-sh">kubectl edit deploy cc-operator-controller-manager -n confidential-containers-system

<span class="hljs-comment"># &#x5C06;gcr.io/kubebuilder/kube-rbac-proxy:v0.13.0&#x66FF;&#x6362;&#x6210;</span>
image: quay.io/brancz/kube-rbac-proxy:v0.13.0
</code></pre>
<p>&#x67E5;&#x770B;&#x8282;&#x70B9;&#x72B6;&#x6001;&#xFF1A;</p>
<pre><code class="lang-sh">kubectl get pods -n confidential-containers-system --watch
</code></pre>
<p>&#x9884;&#x671F;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#x3002;&#x6CE8;&#x610F;&#x8FD9;&#x4E09;&#x4E2A;pod&#x90FD;&#x8981;&#x5B58;&#x5728;&#xFF0C;&#x4E14;STATUS&#x90FD;&#x8981;&#x4E3A;Running&#x3002;</p>
<pre><code class="lang-sh">NAME                                              READY   STATUS    RESTARTS   AGE
cc-operator-controller-manager-56cb4d5ff5-lqd9x   2/2     Running   0          167m
cc-operator-daemon-install-rg8s9                  1/1     Running   0          154m
cc-operator-pre-install-daemon-7jhnw              1/1     Running   0          154m
</code></pre>
<h3 id="&#x521B;&#x5EFA;custom-resource">&#x521B;&#x5EFA;custom resource</h3>
<p>&#x521B;&#x5EFA; custom resource &#x4F1A;&#x5C06;&#x6240;&#x9700;&#x7684; CC runtime&#x5B89;&#x88C5;&#x5230;&#x96C6;&#x7FA4;&#x8282;&#x70B9;&#x4E2D;&#x5E76;&#x521B;&#x5EFA; RuntimeClasses&#x3002;&#x64CD;&#x4F5C;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code class="lang-sh">kubectl apply -k github.com/confidential-containers/operator/config/samples/ccruntime/default?ref=v0.3.0
</code></pre>
<p>&#x68C0;&#x67E5;&#x521B;&#x5EFA;&#x7684; RuntimeClasses&#x3002;</p>
<pre><code class="lang-sh">kubectl get runtimeclass
</code></pre>
<p>&#x9884;&#x671F;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code class="lang-sh">NAME            HANDLER         AGE
kata            kata            154m
kata-clh        kata-clh        154m
kata-clh-tdx    kata-clh-tdx    154m
kata-qemu       kata-qemu       154m
kata-qemu-sev   kata-qemu-sev   154m
kata-qemu-tdx   kata-qemu-tdx   154m
</code></pre>
<h3 id="&#x5378;&#x8F7D;operator&#xFF08;&#x975E;&#x5FC5;&#x8981;&#x6B65;&#x9AA4;&#xFF09;">&#x5378;&#x8F7D;Operator&#xFF08;&#x975E;&#x5FC5;&#x8981;&#x6B65;&#x9AA4;&#xFF09;</h3>
<p>&#x5982;&#x679C;&#x60A8;&#x60F3;&#x66F4;&#x65B0;Operator&#x7684;&#x7248;&#x672C;&#xFF0C;&#x6216;&#x8005;&#x60A8;&#x7684;&#x5B89;&#x88C5;&#x51FA;&#x73B0;&#x95EE;&#x9898;&#xFF0C;&#x53EF;&#x4EE5;&#x5148;&#x5378;&#x8F7D;&#xFF0C;&#x518D;&#x56DE;&#x5230;&#x4E0A;&#x9762;&#x7684;&#x6B65;&#x9AA4;&#x91CD;&#x65B0;&#x5B89;&#x88C5;&#x3002;&#x5177;&#x4F53;&#x64CD;&#x4F5C;&#x8BF7;&#x53C2;&#x8003;<a href="https://github.com/confidential-containers/operator/blob/main/docs/INSTALL.md#uninstallation" target="_blank">&#x94FE;&#x63A5;</a>&#x3002;</p>
<pre><code class="lang-sh">kubectl delete -k github.com/confidential-containers/operator/config/samples/ccruntime/default?ref=&lt;RELEASE_VERSION&gt;
kubectl delete -k github.com/confidential-containers/operator/config/release?ref=<span class="hljs-variable">${RELEASE_VERSION}</span>
</code></pre>
<h2 id="&#x6B65;&#x9AA4;&#x4E09;&#xFF1A;&#x5B89;&#x88C5;&#x5E76;&#x542F;&#x52A8;verdictd">&#x6B65;&#x9AA4;&#x4E09;&#xFF1A;&#x5B89;&#x88C5;&#x5E76;&#x542F;&#x52A8;verdictd</h2>
<p>Verdictd&#x662F;&#x4E00;&#x79CD;&#x8FDC;&#x7A0B;&#x8BA4;&#x8BC1;&#x5B9E;&#x73B0;&#xFF0C;&#x7531;&#x4E00;&#x7EC4;&#x6784;&#x5EFA;&#x5757;&#x7EC4;&#x6210;&#xFF0C;&#x8FD9;&#x4E9B;&#x6784;&#x5EFA;&#x5757;&#x5229;&#x7528;Intel/AMD&#x7684;&#x5B89;&#x5168;&#x7279;&#x6027;&#x6765;&#x53D1;&#x73B0;&#x3001;&#x9A8C;&#x8BC1;&#x548C;&#x652F;&#x6301;&#x5173;&#x952E;&#x7684;&#x57FA;&#x7840;&#x5B89;&#x5168;&#x548C;&#x673A;&#x5BC6;&#x8BA1;&#x7B97;&#x7528;&#x4F8B;&#x3002;&#x5B83;&#x4F9D;&#x9760;RATS-TLS&#x5E94;&#x7528;&#x8FDC;&#x7A0B;&#x8BA4;&#x8BC1;&#x57FA;&#x7840;&#x548C;&#x6807;&#x51C6;&#x89C4;&#x8303;&#x6765;&#x7EF4;&#x62A4;&#x5E73;&#x53F0;&#x6570;&#x636E;&#x6536;&#x96C6;&#x670D;&#x52A1;&#x548C;&#x9AD8;&#x6548;&#x7684;&#x9A8C;&#x8BC1;&#x5F15;&#x64CE;&#x6765;&#x6267;&#x884C;&#x5168;&#x9762;&#x7684;&#x4FE1;&#x4EFB;&#x8BC4;&#x4F30;&#x3002;&#x8FD9;&#x4E9B;&#x4FE1;&#x4EFB;&#x8BC4;&#x4F30;&#x53EF;&#x7528;&#x4E8E;&#x7BA1;&#x7406;&#x5E94;&#x7528;&#x4E8E;&#x4EFB;&#x4F55;&#x7ED9;&#x5B9A;&#x5DE5;&#x4F5C;&#x8D1F;&#x8F7D;&#x7684;&#x4E0D;&#x540C;&#x4FE1;&#x4EFB;&#x548C;&#x5B89;&#x5168;&#x7B56;&#x7565;&#x3002; &#x66F4;&#x591A;&#x4FE1;&#x606F;&#x8BF7;&#x53C2;&#x8003;<a href="https://github.com/inclavare-containers/verdictd" target="_blank">verdictd</a>&#x9879;&#x76EE;&#x6587;&#x6863;&#x3002;</p>
<h3 id="1-&#x8BF7;&#x6267;&#x884C;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#xFF0C;&#x5B89;&#x88C5;verdictd">1. &#x8BF7;&#x6267;&#x884C;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#xFF0C;&#x5B89;&#x88C5;verdictd</h3>
<pre><code class="lang-sh">yum install -y verdictd
</code></pre>
<h3 id="2-&#x90E8;&#x7F72;&#x955C;&#x50CF;&#x52A0;&#x5BC6;&#x5BC6;&#x94A5;">2. &#x90E8;&#x7F72;&#x955C;&#x50CF;&#x52A0;&#x5BC6;&#x5BC6;&#x94A5;</h3>
<pre><code class="lang-sh">mkdir -p /opt/verdictd/keys/ 

cat &lt;&lt;- EOF &gt; /opt/verdictd/keys/84688df7-2c0c-40fa-956b-29d8e74d16c0
1234567890123456789012345678901
EOF
</code></pre>
<h3 id="3-&#x90E8;&#x7F72;&#x955C;&#x50CF;&#x7B7E;&#x540D;&#x5BC6;&#x94A5;">3. &#x90E8;&#x7F72;&#x955C;&#x50CF;&#x7B7E;&#x540D;&#x5BC6;&#x94A5;</h3>
<pre><code class="lang-sh"><span class="hljs-comment"># &#x5B89;&#x88C5;&#x955C;&#x50CF;&#x7B7E;&#x540D;&#x5DE5;&#x5177;cosign: https://github.com/sigstore/cosign#installation</span>
wget https://github.com/sigstore/cosign/releases/download/v2.0.0/cosign-linux-amd64
sudo install -D --owner root --group root --mode 0755 cosign-linux-amd64 /usr/<span class="hljs-built_in">local</span>/bin/cosign

<span class="hljs-comment"># &#x751F;&#x6210;&#x65B0;&#x7684;&#x5BC6;&#x94A5;&#x5BF9;</span>
cosign generate-key-pair
ls
cosign.key  cosign.pub
mkdir -p /opt/verdictd/image/
cp cosign.pub /opt/verdictd/image/cosign.key
</code></pre>
<h3 id="4-&#x90E8;&#x7F72;&#x955C;&#x50CF;policy">4. &#x90E8;&#x7F72;&#x955C;&#x50CF;policy</h3>
<blockquote>
<p>&#x6CE8;&#x610F;&#xFF1A;&#x5728;&#x5B9E;&#x9645;&#x64CD;&#x4F5C;&#x4E2D;&#xFF0C;&#x5E94;&#x5C06;&#x7528;&#x6237;docker.io/test&#x66F4;&#x540D;&#x4E3A;&#x5B9E;&#x9645;&#x64CD;&#x4F5C;&#x7684;&#x7528;&#x6237;&#x540D;&#xFF0C;docker.io/xxxx&#x3002;</p>
</blockquote>
<pre><code class="lang-sh">cat &lt;&lt;EOF | sudo tee /opt/verdictd/image/policy.json
{
    <span class="hljs-string">&quot;default&quot;</span>: [
        {
            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot; insecureAcceptAnything&quot;</span>
        }
    ],
    <span class="hljs-string">&quot;transports&quot;</span>: {
        <span class="hljs-string">&quot;docker&quot;</span>: {
            <span class="hljs-string">&quot; docker.io/test/&quot;</span>: [
                {
                    <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;sigstoreSigned&quot;</span>,
                    <span class="hljs-string">&quot;keyPath&quot;</span>: <span class="hljs-string">&quot;/run/image-security/cosign/cosign.pub&quot;</span>
                }
            ]
        }
    }
}
EOF
</code></pre>
<h3 id="5-&#x542F;&#x52A8;verdictd">5. &#x542F;&#x52A8;verdictd</h3>
<pre><code class="lang-sh">verdictd --listen 0.0.0.0:20002 --verifier tdx --attester nullattester --client-api 127.0.0.1:20001 --mutual
</code></pre>
<p>&#x5F53;Verdictd&#x542F;&#x52A8;&#x540E;&#xFF0C;Verdictd&#x5728;&#x7AEF;&#x53E3;&#x76D1;&#x542C;&#x5730;&#x5740;0.0.0.0:20002&#x76D1;&#x542C;&#x6765;&#x81EA;attestation agent&#x7684;&#x8FDC;&#x7A0B;&#x8BC1;&#x660E;&#x8BF7;&#x6C42;&#x3002;</p>
<h3 id="6-&#x5236;&#x4F5C;&#x52A0;&#x5BC6;image">6. &#x5236;&#x4F5C;&#x52A0;&#x5BC6;image</h3>
<p>&#x53EF;&#x53C2;&#x8003;<a href="https://github.com/inclavare-containers/verdictd#generate-encrypted-container-image" target="_blank">Generate encrypted container image</a>&#x5236;&#x4F5C;&#x52A0;&#x5BC6;&#x955C;&#x50CF;&#x3002; </p>
<p>&#x6CE8;&#x610F;&#x4E8B;&#x9879;&#xFF1A;&#x5728;&#x673A;&#x5BC6;&#x8BA1;&#x7B97;&#x573A;&#x666F;&#x4E2D;&#xFF0C;&#x52A0;&#x5BC6;&#x955C;&#x50CF;&#x662F;&#x5728;guest VM&#x4E2D;&#x7531;imgae-rs &#x7EC4;&#x4EF6;&#x8D1F;&#x8D23;&#x62C9;&#x53D6;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x5728;host&#x8FDB;&#x884C;&#x62C9;&#x53D6;&#x3002; &#x5982;&#x679C;&#x60A8;&#x51FA;&#x4E8E;&#x7814;&#x7A76;&#x7684;&#x76EE;&#x7684;&#xFF0C;&#x60F3;&#x67E5;&#x770B;&#x52A0;&#x5BC6;&#x955C;&#x50CF;&#x7684;&#x5185;&#x5BB9;&#x3002;&#x8BF7;&#x6CE8;&#x610F;<strong>&#x7531;&#x4E8E;&#x955C;&#x50CF;&#x662F;&#x52A0;&#x5BC6;&#x7684;&#xFF0C;&#x7528;&#x5E38;&#x89C4;&#x7684;<code>docker</code>&#xFF0C;<code>ctr</code> &#x548C; <code>crictl</code> &#x90FD;&#x65E0;&#x6CD5;&#x6B63;&#x5E38;&#x62C9;&#x53D6;&#x3002;&#x8BF7;&#x4F7F;&#x7528;<code>skopeo</code>&#x5DE5;&#x5177;&#x8FDB;&#x884C;&#x955C;&#x50CF;&#x7684;&#x62C9;&#x53D6;</strong>&#x3002;&#x53C2;&#x8003;&#x547D;&#x4EE4;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code class="lang-sh"><span class="hljs-comment"># &#x4E0B;&#x8F7D;&#x4E00;&#x4E2A;&#x660E;&#x6587;image</span>
skopeo copy docker://docker.io/library/alpine:latest oci:alpine

<span class="hljs-comment"># &#x4E3A;skopeo&#x751F;&#x6210;&#x4E00;&#x4E2A;keyprovider&#x914D;&#x7F6E;&#x6587;&#x4EF6;</span>
$ sudo mkdir -p /etc/containerd/ocicrypt/
$ cat &lt;&lt;- EOF | sudo tee <span class="hljs-string">&quot;/etc/containerd/ocicrypt/ocicrypt_keyprovider.conf&quot;</span>
{
        <span class="hljs-string">&quot;key-providers&quot;</span>: {
                <span class="hljs-string">&quot;attestation-agent&quot;</span>: {
                    <span class="hljs-string">&quot;grpc&quot;</span>: <span class="hljs-string">&quot;127.0.0.1:20001&quot;</span>

                }
        }
}
EOF

<span class="hljs-built_in">export</span> OCICRYPT_KEYPROVIDER_CONFIG=/etc/containerd/ocicrypt/ocicrypt_keyprovider.conf

<span class="hljs-comment"># &#x751F;&#x6210;&#x52A0;&#x5BC6;image&#x5E76;&#x4FDD;&#x5B58;&#x5728;&#x8FDC;&#x7AEF;docker registry</span>
</code></pre>
<blockquote>
<p>&#x6CE8;&#x610F;&#xFF1A;&#x5728;&#x5B9E;&#x9645;&#x64CD;&#x4F5C;&#x4E2D;&#xFF0C;&#x5E94;&#x5C06;&#x7528;&#x6237;docker.io/test&#x66F4;&#x540D;&#x4E3A;&#x5B9E;&#x9645;&#x64CD;&#x4F5C;&#x7684;&#x7528;&#x6237;&#x540D;&#xFF0C;docker.io/xxxx&#x3002;</p>
</blockquote>
<pre><code class="lang-sh">skopeo copy --encryption-key provider:attestation-agent:84688df7-2c0c-40fa-956b-29d8e74d16c0 oci:alpine docker://docker.io/<span class="hljs-built_in">test</span>/alpine-encrypted
{map[attestation-agent:{&lt;nil&gt; 127.0.0.1:50001}]}
&amp;{map[attestation-agent:{&lt;nil&gt; 127.0.0.1:50001}]}
[[97 116 116 101 115 116 97 116 105 111 110 45 97 103 101 110 116 58 56 52 54 56 56 100 102 55 45 50 99 48 99 45 52 48 102 97 45 57 53 54 98 45 50 57 100 56 101 55 52 100 49 54 99 48]]
attestation-agent:84688df7-2c0c-40fa-956b-29d8e74d16c0
idx:  17
map[attestation-agent:[[56 52 54 56 56 100 102 55 45 50 99 48 99 45 52 48 102 97 45 57 53 54 98 45 50 57 100 56 101 55 52 100 49 54 99 48]]]
Getting image <span class="hljs-built_in">source</span> signatures
&amp;{map[attestation-agent:[[56 52 54 56 56 100 102 55 45 50 99 48 99 45 52 48 102 97 45 57 53 54 98 45 50 57 100 56 101 55 52 100 49 54 99 48]]] {map[]}}
Copying blob 63b65145d645 <span class="hljs-keyword">done</span>
Copying config 6a2bcc1c7b <span class="hljs-keyword">done</span>
Writing manifest to image destination
Storing signatures

<span class="hljs-comment"># verdictd &#x65E5;&#x5FD7;</span>
[2023-02-27T06:02:18Z INFO  verdictd::client_api::key_provider] wrap_<span class="hljs-built_in">command</span>: KeyProviderInput { op: <span class="hljs-string">&quot;keywrap&quot;</span>, keywrapparams: KeyWrapParams { ec: Some(Ec { Parameters: {<span class="hljs-string">&quot;attestation-agent&quot;</span>: [<span class="hljs-string">&quot;ODQ2ODhkZjctMmMwYy00MGZhLTk1NmItMjlkOGU3NGQxNmMw&quot;</span>]}, DecryptConfig: Dc { Parameters: {} } }), optsdata: Some(<span class="hljs-string">&quot;eyJzeW1rZXkiOiIycEVxWk9jNVhyUmN0WXdyQzl1UlJmSkZ5WGM2ZnV2SWZUckhnMHEyM0RrPSIsImRpZ2VzdCI6InNoYTI1Njo2M2I2NTE0NWQ2NDVjMTI1MGMzOTFiMmQxNmViZTUzYjM3NDdjMjk1Y2E4YmEyZmNiNmIwY2YwNjRhNGRjMjFjIiwiY2lwaGVyb3B0aW9ucyI6eyJub25jZSI6IkNURk5UZ2hZL0pkRkd0eGNKYzc5dUE9PSJ9fQ==&quot;</span>) }, keyunwrapparams: KeyUnwrapParams { dc: None, annotation: None } }
[2023-02-27T06:02:18Z INFO  verdictd::resources::directory_key_manager] get key from keyFile: /opt/verdictd/keys/84688df7-2c0c-40fa-956b-29d8e74d16c0
[2023-02-27T06:02:18Z INFO  verdictd::client_api::key_provider] key: [49, 50, 51, 52, 53, 54, 55, 56, 57, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 48, 49, 10]
</code></pre>
<h3 id="7-&#x5236;&#x4F5C;&#x7B7E;&#x540D;image">7. &#x5236;&#x4F5C;&#x7B7E;&#x540D;image</h3>
<pre><code class="lang-sh"><span class="hljs-comment"># &#x4E0B;&#x8F7D;&#x4E00;&#x4E2A;&#x660E;&#x6587;image</span>
cosign sign --key cosign.key docker.io/<span class="hljs-built_in">test</span>/alpine-encrypted
tlog entry created with index: 14409560
Pushing signature to: docker.io/<span class="hljs-built_in">test</span>/alpine-encrypted
</code></pre>
<h2 id="&#x6B65;&#x9AA4;&#x56DB;&#xFF1A;&#x542F;&#x52A8;&#x5E76;&#x9A8C;&#x8BC1;&#x5E26;&#x7B7E;&#x540D;&#x7684;&#x52A0;&#x5BC6;&#x955C;&#x50CF;">&#x6B65;&#x9AA4;&#x56DB;&#xFF1A;&#x542F;&#x52A8;&#x5E76;&#x9A8C;&#x8BC1;&#x5E26;&#x7B7E;&#x540D;&#x7684;&#x52A0;&#x5BC6;&#x955C;&#x50CF;</h2>
<h3 id="1----&#x914D;&#x7F6E;tdx-coco-runtime">1.    &#x914D;&#x7F6E;TDX CoCo runtime</h3>
<p>attestation agent &#x652F;&#x6301;TDX&#x5E73;&#x53F0;&#x7684;KBC&#x4E3A;&#xFF1A;eaa_kbc &#xFF0C; &#x8FDC;&#x7AEF;verdictd service&#x7528;&#x4E8E;&#x63D0;&#x4F9B;&#x9A8C;&#x8BC1;&#x548C;image&#x89E3;&#x5BC6;key&#xFF0C;&#x7B7E;&#x540D;&#x7684;policy&#x548C;&#x5BC6;&#x94A5;&#x4FE1;&#x606F;&#x3002;</p>
<pre><code class="lang-sh">vim /opt/confidential-containers/share/defaults/kata-containers/configuration-qemu-tdx.toml
<span class="hljs-comment"># EAA KBC is specified as: eaa_kbc::host_ip:port</span>
kernel_params = <span class="hljs-string">&quot;&lt;default kernel params&gt; agent.aa_kbc_params=eaa_kbc::verdictd_ip_address:20002 agent.enable_signature_verification=true&quot;</span>
</code></pre>
<h3 id="2----&#x90E8;&#x7F72;pod">2.    &#x90E8;&#x7F72;Pod</h3>
<blockquote>
<p>&#x6CE8;&#x610F;&#xFF1A;&#x5728;&#x5B9E;&#x9645;&#x64CD;&#x4F5C;&#x4E2D;&#xFF0C;&#x5E94;&#x5C06;&#x7528;&#x6237;docker.io/test&#x66F4;&#x540D;&#x4E3A;&#x5B9E;&#x9645;&#x64CD;&#x4F5C;&#x7684;&#x7528;&#x6237;&#x540D;&#xFF0C;docker.io/xxxx&#x3002;</p>
</blockquote>
<pre><code class="lang-sh">cat &lt;&lt;-EOF | kubectl apply <span class="hljs-_">-f</span> -
apiVersion: v1
kind: Pod
metadata:
  name: <span class="hljs-built_in">test</span>-tdx-alpine
spec:
  runtimeClassName: kata-qemu-tdx
  containers:
  - image: docker.io/<span class="hljs-built_in">test</span>/alpine-encrypted
    <span class="hljs-built_in">command</span>:
      - top
    imagePullPolicy: Always
    name: <span class="hljs-built_in">test</span>-tdx-alpine
  restartPolicy: Never
EOF
</code></pre>
<ul>
<li>&#x67E5;&#x770B; pod &#x662F;&#x5426;&#x542F;&#x52A8;&#x6210;&#x529F;&#xFF1A;</li>
</ul>
<pre><code class="lang-sh">kubectl get po
</code></pre>
<ul>
<li>&#x9884;&#x671F;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#xFF1A;</li>
</ul>
<pre><code class="lang-sh">NAME                READY   STATUS    RESTARTS   AGE
<span class="hljs-built_in">test</span>-tdx-alpine      1/1     Running   0          31h

kubectl describe pod <span class="hljs-built_in">test</span>-tdx-alpine
  Normal  Pulling    5s    kubelet            Pulling image <span class="hljs-string">&quot; docker.io/test/alpine-encrypted &quot;</span>
  Normal  Pulled     3s    kubelet            Successfully pulled image <span class="hljs-string">&quot; docker.io/test/alpine-encrypted &quot;</span> <span class="hljs-keyword">in</span> 1.682344015s (1.682349283s including waiting)
  Normal  Created    3s    kubelet            Created container <span class="hljs-built_in">test</span>-tdx-alpine
  Normal  Started    3s    kubelet            Started container <span class="hljs-built_in">test</span>-tdx-alpine
&#xB7;
<span class="hljs-comment"># verdictd &#x65E5;&#x5FD7;</span>
[2023-03-01T08:19:45Z INFO  verdictd::attestation_agent::rats_tls] response: {<span class="hljs-string">&quot;data&quot;</span>:{<span class="hljs-string">&quot;base64size&quot;</span>:<span class="hljs-string">&quot;452&quot;</span>},<span class="hljs-string">&quot;status&quot;</span>:<span class="hljs-string">&quot;OK&quot;</span>}
[2023-03-01T08:19:45Z INFO  verdictd::attestation_agent::protocol] Request: Object {<span class="hljs-string">&quot;command&quot;</span>: String(<span class="hljs-string">&quot;Get Policy&quot;</span>), <span class="hljs-string">&quot;optional&quot;</span>: Object {}}
[2023-03-01T08:19:45Z INFO  verdictd::attestation_agent::rats_tls] response: ewogICAgImRlZmF1bHQiOiBbCiAgICAgICAgewogICAgICAgICAgICAidHlwZSI6ICJyZWplY3QiCiAgICAgICAgfQogICAgXSwKICAgICJ0cmFuc3BvcnRzIjogewogICAgICAgICJkb2NrZXIiOiB7CiAgICAgICAgICAgICJyZWdpc3RyeS5kb21haW4ubG9jYWwiOiBbCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAic2lnc3RvcmVTaWduZWQiLAogICAgICAgICAgICAgICAgICAgICJrZXlQYXRoIjogIi9ydW4vaW1hZ2Utc2VjdXJpdHkvY29zaWduL2Nvc2lnbi5wdWIiCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIF0KICAgICAgICB9CiAgICB9Cn0K
[2023-03-01T08:19:45Z INFO  verdictd::attestation_agent::protocol] Request: Object {<span class="hljs-string">&quot;command&quot;</span>: String(<span class="hljs-string">&quot;Get Resource Info&quot;</span>), <span class="hljs-string">&quot;name&quot;</span>: String(<span class="hljs-string">&quot;Cosign Key&quot;</span>)}
[2023-03-01T08:19:45Z INFO  verdictd::attestation_agent::rats_tls] response: {<span class="hljs-string">&quot;data&quot;</span>:{<span class="hljs-string">&quot;base64size&quot;</span>:<span class="hljs-string">&quot;240&quot;</span>},<span class="hljs-string">&quot;status&quot;</span>:<span class="hljs-string">&quot;OK&quot;</span>}
[2023-03-01T08:19:45Z INFO  verdictd::attestation_agent::protocol] Request: Object {<span class="hljs-string">&quot;command&quot;</span>: String(<span class="hljs-string">&quot;Get Cosign Key&quot;</span>), <span class="hljs-string">&quot;optional&quot;</span>: Object {}}
[2023-03-01T08:19:45Z INFO  verdictd::attestation_agent::rats_tls] response: LS0tLS1CRUdJTiBQVUJMSUMgS0VZLS0tLS0KTUZrd0V3WUhLb1pJemowQ0FRWUlLb1pJemowREFRY0RRZ0FFZ3h6NWhEVXl6VnpFd2RVcnhZb1JQVE1pN0ZveQovVEI4OTVlbmtMdzE4RHNLczR1MnFidHg1L1hJNVlKaUJ4TDhyZG9NL3A5clBQSHVDVVdpSkxBSFVnPT0KLS0tLS1FTkQgUFVCTElDIEtFWS0tLS0tCg==EOF
</code></pre>
<footer class="page-footer"><span class="copyright">powered by Gitbook</span><span class="footer-modification">File Modify: 
2023-03-17 20:54:23
</span></footer>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="vcsv.html" class="navigation navigation-prev " aria-label="Previous page: 海光CSV机密虚拟机">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="vsgx.html" class="navigation navigation-next " aria-label="Next page: Intel vSGX：Intel SGX虚拟化">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Intel TDX机密容器","level":"1.5.3","depth":2,"next":{"title":"Intel vSGX：Intel SGX虚拟化","level":"1.5.4","depth":2,"path":"runtime/vsgx.md","ref":"./runtime/vsgx.md","articles":[{"title":"Intel SGX虚拟机最佳实践","level":"1.5.4.1","depth":3,"path":"runtime/run_vsgx.md","ref":"./runtime/run_vsgx.md","articles":[]}]},"previous":{"title":"海光CSV机密虚拟机","level":"1.5.2","depth":2,"path":"runtime/vcsv.md","ref":"./runtime/vcsv.md","articles":[]},"dir":"ltr"},"config":{"plugins":["alerts","tbfed-pagefooter","sectionx","expandable-chapters","chapter-fold","emphasize","chapter-fold","hide-element","tags","text-highlight","hints","-sharing","sharing-plus","edit-link"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"tbfed-pagefooter":{},"chapter-fold":{},"emphasize":{},"search":{},"sharing-plus":{"qq":false,"all":["facebook","google","twitter","instapaper","linkedin","pocket","stumbleupon"],"douban":false,"facebook":true,"weibo":false,"instapaper":false,"whatsapp":false,"hatenaBookmark":false,"twitter":true,"messenger":false,"line":false,"vk":false,"pocket":true,"google":false,"viber":false,"stumbleupon":false,"qzone":false,"linkedin":false},"hints":{"danger":"fa fa-exclamation-circle","info":"fa fa-info-circle","tip":"fa fa-mortar-board","working":"fa fa-wrench"},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"hide-element":{"elements":[".gitbook-link"]},"fontsettings":{"theme":"white","family":"sans","size":2},"sectionx":{"tag":"b"},"text-highlight":{},"highlight":{},"alerts":{},"tags":{"placement":"top"},"sharing":{"qq":false,"all":["weibo"],"douban":true,"facebook":false,"weibo":true,"instapaper":false,"whatsapp":false,"hatenaBookmark":false,"twitter":false,"messenger":false,"line":false,"vk":false,"pocket":false,"google":false,"viber":false,"stumbleupon":false,"qzone":true,"linkedin":false},"edit-link":{"label":"编辑","base":"https://github.com/houhuiting/cncc-sig-white-paper/edit/master"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"expandable-chapters":{}},"theme":"default","author":"CNCC-sig.cn","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"introduction.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"CNCC-sig","language":"zh-hans","gitbook":">= 3.2.2","description":"CNCC-sig"},"file":{"path":"runtime/tdx.md","mtime":"2023-03-17T12:54:23.043Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2023-03-17T12:57:24.915Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-alerts/plugin.js"></script>
        
    
        
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sectionx/sectionx.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-chapter-fold/chapter-fold.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-hide-element/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing-plus/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-edit-link/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

